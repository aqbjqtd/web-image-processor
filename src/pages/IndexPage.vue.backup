
<template>
  <q-page class="modern-dashboard">
  <q-page class="modern-dashboard">
    <!-- 页面头部 -->
    <div class="page-header">
      <div class="header-content">
        <div class="title-section">
          <q-icon name="photo_library" class="title-icon" />
          <div class="title-text">
            <h1 class="main-title">智能图像处理</h1>
            <p class="subtitle">高效、现代化的图像处理解决方案</p>
          </div>
        </div>
        <div class="header-actions">
          <q-btn
            flat
            round
            :icon="$q.dark.isActive ? 'light_mode' : 'dark_mode'"
            @click="toggleTheme"
            class="theme-toggle"
            size="md"
          >
            <q-tooltip>{{ $q.dark.isActive ? '切换到浅色模式' : '切换到深色模式' }}</q-tooltip>
          </q-btn>
        </div>
      </div>
    </div>

    <!-- 统计卡片 -->
    <div class="stats-grid">
      <q-card class="stat-card">
        <q-card-section class="stat-content">
          <q-icon name="upload" class="stat-icon" />
          <div class="stat-data">
            <div class="stat-number">{{ fileList.length }}</div>
            <div class="stat-label">已上传文件</div>
          </div>
        </q-card-section>
      </q-card>
      
      <q-card class="stat-card">
        <q-card-section class="stat-content">
          <q-icon name="check_circle" class="stat-icon" />
          <div class="stat-data">
            <div class="stat-number">{{ processedImages.length }}</div>
            <div class="stat-label">已处理文件</div>
          </div>
        </q-card-section>
      </q-card>
      
      <q-card class="stat-card">
        <q-card-section class="stat-content">
          <q-icon name="folder_open" class="stat-icon" />
          <div class="stat-data">
            <div class="stat-number">{{ formatFileSize(getTotalSize()) }}</div>
            <div class="stat-label">输出大小</div>
          </div>
        </q-card-section>
      </q-card>
      
      <q-card class="stat-card">
        <q-card-section class="stat-content">
          <q-icon name="done_all" class="stat-icon" />
          <div class="stat-data">
            <div class="stat-number">{{ processing ? processedCount : (processedImages.length > 0 ? processedImages.length : '0') }}</div>
            <div class="stat-label">处理完成</div>
          </div>
        </q-card-section>
      </q-card>
    </div>

    <!-- 功能模块卡片网格 -->
    <div class="feature-grid">
      <!-- 上传模块卡片 -->
      <q-card class="feature-card upload-card">
        <q-card-section class="card-header">
          <div class="header-content">
            <q-icon name="cloud_upload" class="header-icon" />
            <span class="header-title">文件上传</span>
          </div>
        </q-card-section>
        
        <q-card-section class="card-content">
          <div 
            class="drop-zone" 
            :class="{ 'drop-active': isDragOver }"
            @drop="onDrop"
            @dragover="onDragOver"
            @dragleave="onDragLeave"
          >
            <div class="drop-content">
              <q-icon name="upload_file" size="48px" class="upload-icon" />
              <div class="upload-text">拖拽文件到此处或点击选择</div>
              <div class="upload-hint">支持 PNG, JPG, JPEG, BMP, GIF, WebP 格式</div>
            </div>
          </div>
          
          <div class="upload-actions">
            <q-btn
              unelevated
              color="primary"
              icon="add_photo_alternate"
              label="选择图片文件"
              @click="triggerFileSelect"
              class="upload-btn"
            />
            <q-btn
              outline
              color="primary"
              icon="folder_open"
              label="选择文件夹"
              @click="selectFolder"
              class="upload-btn"
            />
          </div>
        </q-card-section>
      </q-card>

      <!-- 配置模块卡片 -->
      <q-card class="feature-card config-card">
        <q-card-section class="card-header">
          <div class="header-content">
            <q-icon name="tune" class="header-icon" />
            <span class="header-title">处理配置</span>
          </div>
        </q-card-section>
        
        <q-card-section class="card-content">
          <div class="config-grid">
            <div class="config-item">
              <div class="config-label">目标尺寸 (px)</div>
              <div class="size-inputs">
                <q-input
                  v-model.number="targetWidth"
                  type="number"
                  placeholder="800"
                  outlined
                  dense
                  class="size-input"
                  label="宽度"
                />
                <q-input
                  v-model.number="targetHeight"
                  type="number"
                  placeholder="600"
                  outlined
                  dense
                  class="size-input"
                  label="高度"
                />
              </div>
            </div>

            <div class="config-item">
              <div class="config-label">调整模式</div>
              <q-select
                v-model="resizeMode"
                :options="resizeModeOptions"
                outlined
                dense
                class="mode-select"
                label="选择调整方式"
              />
            </div>

            <div class="config-row">
              <div class="config-item">
                <div class="config-label">分辨率 (DPI)</div>
                <q-input
                  v-model.number="resolution"
                  type="number"
                  placeholder="300"
                  outlined
                  dense
                  label="DPI"
                />
              </div>
              <div class="config-item">
                <div class="config-label">最大文件大小 (KB)</div>
                <q-input
                  v-model.number="maxFileSize"
                  type="number"
                  placeholder="300"
                  outlined
                  dense
                  label="KB"
                />
              </div>
            </div>

            <div class="checkbox-group">
              <q-checkbox
                v-model="keepOriginalSize"
                label="保持原始尺寸"
                class="config-checkbox"
              />
              <q-checkbox
                v-model="percentageResize"
                label="百分比缩放模式"
                class="config-checkbox"
              />
            </div>
          </div>
        </q-card-section>
      </q-card>

      <!-- 待处理文件卡片 -->
      <q-card class="feature-card pending-card">
        <q-card-section class="card-header">
          <div class="header-content">
            <q-icon name="schedule" class="header-icon" />
            <span class="header-title">待处理文件</span>
            <q-badge color="primary" text-color="white" class="count-badge">
              {{ fileList.length }}
            </q-badge>
          </div>
        </q-card-section>
        
        <q-card-section class="card-content">
          <div v-if="fileList.length > 0" class="file-list">
            <div
              v-for="(file, index) in fileList"
              :key="index"
              class="file-item"
            >
              <q-icon name="image" class="file-icon" />
              <div class="file-info">
                <div class="file-name">{{ file.name }}</div>
                <div class="file-size">{{ formatFileSize(file.size) }}</div>
              </div>
              <q-btn
                flat
                round
                dense
                icon="close"
                @click="removeFile(index)"
                class="remove-btn"
                size="sm"
              />
            </div>
          </div>
          <div v-else class="empty-state">
            <q-icon name="photo_library" size="48px" class="empty-icon" />
            <div class="empty-text">暂无待处理文件</div>
          </div>
        </q-card-section>
      </q-card>

      <!-- 处理控制卡片 -->
      <q-card class="feature-card control-card">
        <q-card-section class="card-header">
          <div class="header-content">
            <q-icon name="play_circle" class="header-icon" />
            <span class="header-title">处理控制</span>
          </div>
        </q-card-section>
        
        <q-card-section class="card-content">
          <div v-if="!processing" class="control-ready">
            <q-btn
              unelevated
              color="positive"
              icon="play_arrow"
              label="开始处理"
              :disable="fileList.length === 0"
              @click="startProcessing"
              class="process-btn full-width"
              size="lg"
            />
          </div>
          <div v-else class="control-active">
            <q-btn
              outline
              color="negative"
              icon="stop"
              label="停止处理"
              @click="stopProcessing"
              class="process-btn full-width"
              size="lg"
            />
            
            <div class="progress-section">
              <div class="progress-header">
                <span>处理进度</span>
                <span class="progress-count">{{ processedCount }}/{{ totalCount }}</span>
              </div>
              <q-linear-progress
                :value="progress"
                color="positive"
                size="12px"
                rounded
                class="progress-bar"
              />
              <div class="progress-percentage">{{ Math.round(progress * 100) }}%</div>
            </div>
          </div>
        </q-card-section>
      </q-card>

      <!-- 已处理文件卡片 -->
      <q-card class="feature-card output-card">
        <q-card-section class="card-header">
          <div class="header-content">
            <q-icon name="folder" class="header-icon" />
            <span class="header-title">已处理文件</span>
            <q-badge color="positive" text-color="white" class="count-badge">
              {{ processedImages.length }}
            </q-badge>
          </div>
          <div class="header-actions" v-if="processedImages.length > 0">
            <q-btn
              unelevated
              color="positive"
              icon="download"
              label="全部下载"
              @click="downloadAll"
              dense
              class="download-all-btn"
            />
            <q-btn
              flat
              icon="clear_all"
              @click="clearProcessedImages"
              dense
              class="clear-btn"
            >
              <q-tooltip>清空已处理文件</q-tooltip>
            </q-btn>
          </div>
        </q-card-section>
        
        <q-card-section class="card-content">
          <div v-if="processedImages.length > 0" class="processed-list">
            <div
              v-for="(image, index) in processedImages"
              :key="index"
              class="processed-item"
            >
              <div class="thumbnail-container">
                <img 
                  :src="image.dataUrl" 
                  :alt="image.name"
                  class="file-thumbnail"
                  @click="previewImage(image)"
                  @error="onThumbnailError($event, image)"
                />
                <div class="thumbnail-overlay">
                  <q-icon name="zoom_in" class="zoom-icon" />
                </div>
              </div>
              <div class="file-info">
                <div class="file-name" :title="image.name">{{ image.name }}</div>
                <div class="file-details">
                  <div class="file-size">{{ image.processedSize ? `${image.processedSize.width}×${image.processedSize.height}` : '处理完成' }}</div>
                  <div class="file-format">{{ getFileFormat(image.name) }}</div>
                </div>
              </div>
              <div class="file-actions">
                <q-btn
                  flat
                  round
                  dense
                  icon="visibility"
                  @click="previewImage(image)"
                  class="action-btn"
                  size="sm"
                >
                  <q-tooltip>预览</q-tooltip>
                </q-btn>
                <q-btn
                  flat
                  round
                  dense
                  icon="download"
                  @click="downloadSingle(image)"
                  class="action-btn"
                  size="sm"
                >
                  <q-tooltip>下载</q-tooltip>
                </q-btn>
              </div>
            </div>
          </div>
          <div v-else class="empty-state">
            <q-icon name="photo_library" size="48px" class="empty-icon" />
            <div class="empty-text">暂无已处理文件</div>
          </div>
        </q-card-section>
      </q-card>
    </div>

    <!-- 隐藏的文件输入 -->
    <input
      ref="fileInput"
      type="file"
      multiple
      accept=".jpg,.jpeg,.png,.bmp,.gif,.webp"
      style="display: none"
      @change="onFileInputChange"
    />

    <!-- 移动端快速操作浮动按钮 -->
    <q-page-sticky position="bottom-right" :offset="[18, 18]" class="lt-md">
      <q-fab
        v-model="fabOpen"
        color="primary"
        icon="add"
        active-icon="close"
        direction="up"
        padding="sm"
      >
        <q-fab-action
          color="positive"
          @click="triggerFileSelect"
          icon="photo_camera"
          label="选择图片"
          padding="sm"
        />
        <q-fab-action
          color="info"
          @click="selectFolder"
          icon="folder"
          label="选择文件夹"
          padding="sm"
        />
        <q-fab-action
          v-if="fileList.length > 0"
          color="negative"
          @click="clearFiles"
          icon="clear_all"
          label="清空文件"
          padding="sm"
        />
      </q-fab>
    </q-page-sticky>

    <!-- 图片预览对话框 -->
    <q-dialog v-model="showPreview" maximized>
      <q-card class="preview-dialog">
        <q-card-section class="preview-header">
          <div class="text-h6">{{ previewImageData?.name }}</div>
          <q-space />
          <q-btn
            flat
            round
            icon="close"
            @click="showPreview = false"
          />
        </q-card-section>
        
        <q-card-section class="preview-content">
          <q-img
            v-if="previewImageData"
            :src="previewImageData.dataUrl"
            :alt="previewImageData.name"
            fit="contain"
            class="preview-image"
          />
        </q-card-section>
        
        <q-card-actions class="preview-actions" align="center">
          <q-btn
            unelevated
            color="primary"
            icon="download"
            label="下载图片"
            @click="downloadSingle(previewImageData)"
            rounded
          />
          <q-btn
            flat
            label="关闭"
            @click="showPreview = false"
            rounded
          />
        </q-card-actions>
      </q-card>
    </q-dialog>
  </q-page>
</template>

<script>
import { defineComponent, ref, computed } from 'vue';
import { useQuasar } from 'quasar';
import ImageProcessor from '../utils/ImageProcessor';

export default defineComponent({
  name: 'IndexPage',
  setup() {
    const $q = useQuasar();

    // 数据状态
    const fileList = ref([]);
    const processing = ref(false);
    const progress = ref(0);
    const processedCount = ref(0);
    const totalCount = ref(0);
    const processedImages = ref([]);
    const showPreview = ref(false);
    const previewImageData = ref(null);
    const isDragOver = ref(false);
    const fileInput = ref(null);
    const fabOpen = ref(false);

    // 配置选项
    const keepOriginalSize = ref(false);
    const percentageResize = ref(false);
    const targetWidth = ref(800);
    const targetHeight = ref(600);
    const resizePercentage = ref(100);
    const resizeMode = ref('keep_ratio_pad');
    const maxFileSize = ref(300);
    const resolution = ref(300);

    const resizeModeOptions = [
      { label: '保持比例填充', value: 'keep_ratio_pad' },
      { label: '保持比例裁剪', value: 'keep_ratio_crop' },
      { label: '拉伸填充', value: 'stretch' }
    ];

    // 主题切换
    const toggleTheme = () => {
      $q.dark.toggle();
    };

    // 图片处理器实例
    const imageProcessor = new ImageProcessor();

    // 文件操作函数
    const triggerFileSelect = () => {
      fileInput.value.click();
    };

    const onFileInputChange = (event) => {
      const files = Array.from(event.target.files);
      addFiles(files);
    };

    const addFiles = (files) => {
      const imageFiles = files.filter(file => 
        /\.(jpg|jpeg|png|bmp|gif|webp)$/i.test(file.name)
      );
      const existingNames = new Set(fileList.value.map(f => f.name));
      const newFiles = imageFiles.filter(file => !existingNames.has(file.name));

      fileList.value = [...fileList.value, ...newFiles];

      if (newFiles.length > 0) {
        $q.notify({
          type: 'positive',
          message: `已添加 ${newFiles.length} 个图片文件`,
          position: 'top',
          timeout: 2000
        });
      }
    };

    const onDrop = (event) => {
      event.preventDefault();
      isDragOver.value = false;

      const files = Array.from(event.dataTransfer.files);
      addFiles(files);
    };

    const onDragOver = (event) => {
      event.preventDefault();
      isDragOver.value = true;
    };

    const onDragLeave = (event) => {
      event.preventDefault();
      isDragOver.value = false;
    };

    const selectFolder = () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.webkitdirectory = true;
      input.multiple = true;
      input.accept = '.jpg,.jpeg,.png,.bmp,.gif,.webp';

      input.onchange = (e) => {
        const files = Array.from(e.target.files);
        addFiles(files);
      };

      input.click();
    };

    const removeFile = (index) => {
      fileList.value.splice(index, 1);
      $q.notify({
        type: 'info',
        message: '文件已移除',
        position: 'top',
        timeout: 1000
      });
    };

    const clearFiles = () => {
      fileList.value = [];
      processedImages.value = [];
      $q.notify({
        type: 'info',
        message: '所有文件已清空',
        position: 'top',
        timeout: 2000
      });
    };

    const clearProcessedImages = () => {
      processedImages.value = [];
      $q.notify({
        type: 'info',
        message: '已处理文件已清空',
        position: 'top',
        timeout: 2000
      });
    };

    const getTotalSize = computed(() => {
      if (processedImages.value.length === 0) return 0;
      return processedImages.value.reduce((total, image) => {
        return total + (image.processedSize ? image.processedSize.fileSize : 0);
      }, 0);
    });

    const formatFileSize = (bytes) => {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    };

    const startProcessing = async () => {
      if (fileList.value.length === 0) {
        $q.notify({
          type: 'warning',
          message: '请先选择要处理的图片文件',
          position: 'top',
          timeout: 3000
        });
        return;
      }

      processing.value = true;
      processedCount.value = 0;
      totalCount.value = fileList.value.length;
      progress.value = 0;

      const config = {
        keepOriginalSize: keepOriginalSize.value,
        percentageResize: percentageResize.value,
        targetWidth: targetWidth.value,
        targetHeight: targetHeight.value,
        resizePercentage: resizePercentage.value,
        resizeMode: resizeMode.value,
        maxFileSize: maxFileSize.value,
        resolution: resolution.value
      };

      try {
        for (let i = 0; i < fileList.value.length; i++) {
          if (!processing.value) break;

          const file = fileList.value[i];
          const processedImage = await imageProcessor.processImage(file, config);

          processedImages.value.push(processedImage);
          processedCount.value++;
          progress.value = processedCount.value / totalCount.value;
        }

        if (processing.value) {
          fileList.value = []; // 清空待处理文件
          $q.notify({
            type: 'positive',
            message: `成功处理 ${processedCount.value} 张图片`,
            position: 'top',
            timeout: 3000
          });
        }
      } catch (error) {
        console.error('处理失败:', error);
        $q.notify({
          type: 'negative',
          message: `处理失败: ${error.message}`,
          position: 'top',
          timeout: 5000
        });
      } finally {
        processing.value = false;
      }
    };

    const stopProcessing = () => {
      processing.value = false;
      $q.notify({
        type: 'info',
        message: '处理已停止',
        position: 'top',
        timeout: 2000
      });
    };

    const previewImage = (image) => {
      previewImageData.value = image;
      showPreview.value = true;
    };

    const downloadSingle = (image) => {
      if (!image || !image.dataUrl) {
        $q.notify({
          type: 'warning',
          message: '图片数据无效',
          position: 'top',
          timeout: 2000
        });
        return;
      }

      const link = document.createElement('a');
      link.download = image.name;
      link.href = image.dataUrl;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      $q.notify({
        type: 'positive',
        message: `正在下载: ${image.name}`,
        position: 'top',
        timeout: 2000
      });
    };

    const downloadAll = () => {
      if (processedImages.value.length === 0) {
        $q.notify({
          type: 'warning',
          message: '没有可下载的图片',
          position: 'top',
          timeout: 2000
        });
        return;
      }

      processedImages.value.forEach((image, index) => {
        setTimeout(() => {
          downloadSingle(image);
        }, index * 200); // 延迟下载避免浏览器限制
      });

      $q.notify({
        type: 'positive',
        message: `开始下载 ${processedImages.value.length} 张图片`,
        position: 'top',
        timeout: 3000
      });
    };

    const getFileFormat = (filename) => {
      const ext = filename.split('.').pop().toUpperCase();
      return ext === 'JPG' ? 'JPEG' : ext;
    };

    const onThumbnailError = (event, image) => {
      console.error('缩略图加载失败:', image.name);
      event.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yNCAyMkg0MEMzMS4xNiAyMiAzNCAxOS4xNiAzNCAxMEMzNCA2Ljg0IDMxLjE2IDQgMjggNEgyMEMxNi44NCA0IDE0IDYuODQgMTQgMTBWNDBDMTQgNDMuMTYgMTYuODQgNDYgMjAgNDZINDRDNDcuMTYgNDYgNTAgNDMuMTYgNTAgNDBWMjJIMzRWMzhaIiBmaWxsPSIjOUNBM0FGIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMCwgMTApIi8+Cjwvc3ZnPgo=';
    };

    return {
      // 状态数据
      fileList,
      processing,
      progress,
      processedCount,
      totalCount,
      processedImages,
      showPreview,
      previewImageData,
      isDragOver,
      fileInput,
      fabOpen,
      
      // 配置选项
      keepOriginalSize,
      percentageResize,
      targetWidth,
      targetHeight,
      resizePercentage,
      resizeMode,
      maxFileSize,
      resolution,
      resizeModeOptions,
      
      // 计算属性
      getTotalSize,
      
      // 方法
      toggleTheme,
      triggerFileSelect,
      onFileInputChange,
      addFiles,
      onDrop,
      onDragOver,
      onDragLeave,
      selectFolder,
      removeFile,
      clearFiles,
      clearProcessedImages,
      formatFileSize,
      startProcessing,
      stopProcessing,
      previewImage,
      downloadSingle,
      downloadAll,
      getFileFormat,
      onThumbnailError
    };
  }
});
</script>
